<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App do Motoboy v11</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8b0000">
    <link rel="icon" type="image/png" sizes="192x192" href="https://placehold.co/192x192/8b0000/ffffff?text=App">
    <link rel="manifest" href="data:application/json;charset=UTF-8,%7B%22name%22%3A%22App%20Motoboy%22%2C%22short_name%22%3A%22Motoboy%22%2C%22start_url%22%3A%22%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f3f4f6%22%2C%22theme_color%22%3A%22%238b0000%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fplacehold.co%2F192x192%2F8b0000%2Fffffff%3Ftext%3DApp%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%2C%7B%22src%22%3A%22https%3A%2F%2Fplacehold.co%2F512x512%2F8b0000%2Fffffff%3Ftext%3DApp%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        #cover-page, #auth-container, #app-container { display: none; }
        body.show-cover #cover-page,
        body.show-auth #auth-container,
        body.show-app #app-container { display: flex; }
        
        .form-toggle-button { background: none; border: none; color: #991b1b; font-weight: 600; cursor: pointer; }
        .form-toggle-button:hover { text-decoration: underline; }
        .tab-button { flex-grow: 1; padding: 0.5rem; font-weight: 600; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; transition: all 300ms; }
        .tab-button.active { background-color: white; color: #991b1b; border-bottom: 2px solid #991b1b; }
        .profile-pic { width: 96px; height: 96px; object-fit: cover; border-radius: 50%; border: 4px solid #fff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        #cover-page .cover-content { animation: fadeInScale 1s ease-out; }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="p-4 justify-center items-center min-h-screen">

    <!-- Capa de Abertura -->
    <div id="cover-page" class="fixed top-0 left-0 w-full h-full justify-center items-center bg-red-800 z-50 flex-col p-4">
        <div class="cover-content text-center text-white">
            <img id="cover-profile-pic" src="https://placehold.co/96x96/8b0000/ffffff?text=App" alt="Foto de Perfil" class="mx-auto mb-4 profile-pic hidden">
            <h1 id="cover-title" class="text-4xl sm:text-5xl font-extrabold mb-4">App do Motoboy</h1>
            <p id="cover-subtitle" class="text-lg sm:text-xl mb-8">Seu controle diário de ganhos e manutenção.</p>
            <button id="enter-app-button" class="bg-white text-red-800 font-semibold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transition">
                Entrar
            </button>
        </div>
    </div>

    <!-- TELA DE LOGIN/CADASTRO -->
    <div id="auth-container" class="w-full max-w-md mx-auto p-8 bg-white rounded-xl shadow-lg flex-col">
        <h2 id="auth-title" class="text-3xl font-bold text-center text-gray-800 mb-6">Entrar</h2>
        <form id="auth-form">
            <div class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" required minlength="6">
                </div>
            </div>
            <button type="submit" id="auth-button" class="mt-6 w-full py-3 px-4 bg-red-800 text-white font-semibold rounded-md shadow-lg hover:bg-red-900 transition">Entrar</button>
        </form>
        <p id="auth-toggle-text" class="mt-6 text-center text-sm text-gray-600">
            Não tem uma conta? <button id="toggle-to-register" class="form-toggle-button">Registre-se</button>
        </p>
    </div>

    <!-- APLICATIVO PRINCIPAL -->
    <div id="app-container" class="w-full max-w-xl bg-white rounded-xl shadow-lg p-6 flex-col">
        <div class="flex justify-between items-center mb-4">
             <h1 class="text-2xl font-bold text-gray-800">Olá, <span id="user-name-display">Usuário</span>!</h1>
            <button id="logout-button" class="text-sm bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-md hover:bg-red-200 transition">Sair</button>
        </div>
        <div class="flex justify-between mb-6 border-b border-gray-200">
            <button data-tab="diario" class="tab-button active">Diário</button>
            <button data-tab="veiculo" class="tab-button">Veículo</button>
            <button data-tab="historico" class="tab-button">Histórico</button>
            <button data-tab="perfil" class="tab-button">Perfil</button>
        </div>
        
        <div id="app-content-placeholder">
            <div data-tab-content="diario" class="tab-content active">
                <p>Conteúdo da Aba Diário</p>
            </div>
            <div data-tab-content="veiculo" class="tab-content">
                <p>Conteúdo da Aba Veículo</p>
            </div>
            <div data-tab-content="historico" class="tab-content">
                <p>Conteúdo da Aba Histórico</p>
            </div>
            <div data-tab-content="perfil" class="tab-content">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Meu Perfil</h2>
                <div class="mb-6 flex flex-col items-center">
                    <img id="profile-pic" class="profile-pic mb-4" src="https://placehold.co/96x96/e5e7eb/6b7280?text=Usuário" alt="Foto do Perfil">
                    <input type="file" id="profile-photo-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                </div>
                <div class="grid grid-cols-1 gap-4 mb-6">
                    <div>
                        <label for="profile-name" class="block text-sm font-medium text-gray-600">Nome <span class="text-red-500">*</span></label>
                        <input type="text" id="profile-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="Seu nome completo" required>
                    </div>
                     <div>
                        <label for="profile-dob" class="block text-sm font-medium text-gray-600">Data de Nascimento <span class="text-red-500">*</span></label>
                        <input type="date" id="profile-dob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" required>
                    </div>
                </div>
                <button id="btn-salvar-perfil" class="mt-6 w-full py-3 px-4 bg-red-800 text-white font-semibold rounded-md shadow-lg hover:bg-red-900 transition">Salvar Perfil</button>
            </div>
        </div>
    </div>

    <!-- MENSAGEM DE ERRO/SUCESSO -->
    <div id="message-box" class="fixed bottom-4 inset-x-2 p-4 bg-gray-800 text-white text-center rounded-lg shadow-xl hidden transition-opacity">
        <p id="message-text"></p>
    </div>

    <!-- SCRIPTS DO FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // **SUAS CHAVES DO FIREBASE AQUI!**
        const firebaseConfig = {
            apiKey: "AIzaSyBW2uf00_Aje5PfV0ss8ZIYlwQrAFPjOSk",
            authDomain: "controle-financeiro-motoboy.firebaseapp.com",
            projectId: "controle-financeiro-motoboy",
            storageBucket: "controle-financeiro-motoboy.appspot.com",
            messagingSenderId: "957860750911",
            appId: "1:957860750911:web:dfae068ae1b5fa0c5f7a8a",
            measurementId: "G-SNFL8JCN9H"
        };

        // INICIALIZAÇÃO DO FIREBASE
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;

        // Ativa a persistência offline
        enableIndexedDbPersistence(db)
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn("Falha ao ativar persistência: múltiplas abas abertas.");
                } else if (err.code == 'unimplemented') {
                    console.warn("Navegador não suporta persistência offline.");
                }
            });

        // --- ELEMENTOS DO DOM ---
        const coverPage = document.getElementById('cover-page');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        let currentUserId = null;
        let isRegisterMode = false;

        // --- MENSAGENS DA CAPA ---
        const motivationalMessages = [
            "Cada entrega é um passo em direção ao seu objetivo. Força!",
            "A cidade não para, e você também não. Bom trabalho!",
            "Sua dedicação é o motor do seu sucesso. Acelera!",
            "Que seu dia seja tão incrível quanto a sensação de pilotar em uma estrada livre.",
            "Lembre-se: você é essencial para a cidade. Tenha um ótimo dia!"
        ];
        const safetyTips = [
            "Dica de segurança: Verifique os freios e os pneus antes de sair.",
            "Sua segurança em primeiro lugar. Use sempre o capacete bem afivelado.",
            "Mantenha distância segura dos outros veículos. Pilotar defensivamente salva vidas.",
            "Cuidado com os pontos cegos dos carros. Seja visto!",
            "Faça pausas regulares para não pilotar cansado. Sua atenção é sua maior proteção."
        ];
        const healthTips = [
            "Dica de saúde: Mantenha-se hidratado. Beba bastante água durante o dia.",
            "Cuide da sua postura na moto para evitar dores nas costas.",
            "Não pule refeições. Uma boa alimentação te dá energia para a jornada.",
            "Alongue-se antes de começar o dia. Seu corpo agradece!",
            "Proteja sua pele do sol. Use protetor solar nas áreas expostas."
        ];

        // --- CONTROLE DE VISIBILIDADE DAS TELAS ---
        function showScreen(screen) {
            document.body.className = `p-4 justify-center items-center min-h-screen show-${screen}`;
        }

        // --- FUNÇÕES DE UI ---
        function showMessage(message, isError = false) {
            messageText.textContent = message;
            messageBox.classList.toggle('bg-red-600', isError);
            messageBox.classList.toggle('bg-gray-800', !isError);
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 4000);
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const authTitle = document.getElementById('auth-title');
            const authButton = document.getElementById('auth-button');
            const authToggleText = document.getElementById('auth-toggle-text');

            authTitle.textContent = isRegisterMode ? 'Criar Conta' : 'Entrar';
            authButton.textContent = isRegisterMode ? 'Registrar-se' : 'Entrar';
            authToggleText.innerHTML = isRegisterMode 
                ? `Já tem uma conta? <button id="toggle-to-login" class="form-toggle-button">Entrar</button>`
                : `Não tem uma conta? <button id="toggle-to-register" class="form-toggle-button">Registre-se</button>`;
            
            if (isRegisterMode) {
                document.getElementById('toggle-to-login').addEventListener('click', toggleAuthMode);
            } else {
                document.getElementById('toggle-to-register').addEventListener('click', toggleAuthMode);
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            const content = document.querySelector(`[data-tab-content="${tabName}"]`);
            if (content) content.classList.add('active');
            
            const button = document.querySelector(`[data-tab="${tabName}"]`);
            if (button) button.classList.add('active');
        }

        function updateCoverPage(profileData = null) {
            const titleEl = document.getElementById('cover-title');
            const subtitleEl = document.getElementById('cover-subtitle');
            const photoEl = document.getElementById('cover-profile-pic');
            
            const firstName = profileData?.name ? profileData.name.split(' ')[0] : '';

            if (firstName) {
                titleEl.textContent = `Olá, ${firstName}!`;
            } else {
                titleEl.textContent = `App do Motoboy`;
            }

            let message = "Seu controle diário de ganhos e manutenção.";
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentDay = today.getDate();

            if (profileData?.dob) {
                const [, month, day] = profileData.dob.split('-').map(Number);
                if (month === currentMonth && day === currentDay) {
                    message = `Feliz aniversário, ${firstName || 'guerreiro'}! Que seu dia seja especial e cheio de alegrias! 🎂`;
                }
            }
            
            if (!message.includes('aniversário')) {
                const allMessages = [...motivationalMessages, ...safetyTips, ...healthTips];
                const randomIndex = Math.floor(Math.random() * allMessages.length);
                message = allMessages[randomIndex];
            }
            
            subtitleEl.textContent = message;

            if (profileData?.photo) {
                photoEl.src = profileData.photo;
                photoEl.classList.remove('hidden');
            } else {
                photoEl.classList.add('hidden');
            }
        }
        
        // --- LÓGICA DE AUTENTICAÇÃO ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                loadAndShowApp();
            } else {
                currentUserId = null;
                updateCoverPage();
                showScreen('cover');
            }
        });

        document.getElementById('enter-app-button').addEventListener('click', () => {
            addAuthEventListeners();
            showScreen('auth');
        });

        function addAuthEventListeners() {
            const authForm = document.getElementById('auth-form');
            document.getElementById('toggle-to-register').addEventListener('click', toggleAuthMode);
            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    if (isRegisterMode) {
                        await createUserWithEmailAndPassword(auth, email, password);
                        showMessage("Conta criada com sucesso! Bem-vindo!");
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        showMessage("Login realizado com sucesso!");
                    }
                } catch (error) {
                    console.error("Erro de autenticação:", error);
                    showMessage(error.message, true);
                }
            });
        }

        // --- LÓGICA DE DADOS COM FIRESTORE ---
        async function loadAndShowApp() {
            if (!currentUserId) return;
            
            try {
                const userDocRef = doc(db, "artifacts", appId, "users", currentUserId);
                const docSnap = await getDoc(userDocRef);

                let profileData = null;
                let vehicleData = null;

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    profileData = data.profile;
                    vehicleData = data.vehicle;
                }

                updateCoverPage(profileData);
                const firstName = profileData?.name?.split(' ')[0] || 'Usuário';
                document.getElementById('user-name-display').textContent = firstName;
                
                loadProfileData(profileData);
                loadVehicleData(vehicleData);

                addAppEventListeners();
                showTab('diario');
                showScreen('app');
            } catch (error) {
                console.error("Falha ao carregar dados do Firestore:", error);
                showMessage("Não foi possível carregar seus dados. Verifique sua conexão e tente novamente.", true);
            }
        }

        function loadProfileData(profileData) {
            if (!profileData) return;
            document.getElementById('profile-name').value = profileData.name || '';
            document.getElementById('profile-dob').value = profileData.dob || '';
            if (profileData.photo) {
                document.getElementById('profile-pic').src = profileData.photo;
            }
        }
        
        function loadVehicleData(vehicleData) {
            if (!vehicleData) return;
            // Preencher campos de veículo aqui
        }

        async function saveProfileData() {
            if (!currentUserId) return;
            const name = document.getElementById('profile-name').value.trim();
            const dob = document.getElementById('profile-dob').value;
            const photo = document.getElementById('profile-pic').src;

            if (!name || !dob) {
                showMessage("Nome e Data de Nascimento são obrigatórios.", true);
                return;
            }
            const profileData = { 
                name, 
                dob,
                photo: photo.startsWith('data:image/') ? photo : null
            };

            const userDocRef = doc(db, "artifacts", appId, "users", currentUserId);
            try {
                await setDoc(userDocRef, { profile: profileData }, { merge: true });
                showMessage("Perfil salvo na nuvem com sucesso!");
                document.getElementById('user-name-display').textContent = name.split(' ')[0];
                updateCoverPage(profileData);
            } catch (error) {
                console.error("Erro ao salvar perfil: ", error);
                showMessage("Erro ao salvar perfil.", true);
            }
        }

        async function saveVehicleData() {
            if (!currentUserId) return;
            // Lógica para salvar dados do veículo aqui
        }
        
        // --- INICIALIZAÇÃO E EVENT LISTENERS GERAIS ---
        
        function addAppEventListeners() {
            document.getElementById('logout-button').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage("Você saiu da sua conta.");
                } catch (error) {
                    showMessage("Erro ao tentar sair.", true);
                }
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => showTab(button.dataset.tab));
            });
            document.getElementById('btn-salvar-perfil')?.addEventListener('click', saveProfileData);
            document.getElementById('profile-photo-input')?.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => document.getElementById('profile-pic').src = e.target.result;
                    reader.readAsDataURL(file);
                }
            });
        }
        
    </script>

</body>
</html>
